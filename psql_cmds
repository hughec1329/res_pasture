# postgrees and postgis install and setup notes
# 20130830 HCrockford
#

# install postgres
sudo apt-get install postgresql-9.1 postgis postgresql-9.1-postgis
# get access to db
sudo su postgres
# create user
createuser -d -E -i -l -P -r -s timlinux


#create templatea - from http://gis.stackexchange.com/questions/19432/why-does-postgis-installation-not-create-a-template-postgis

sudo su postgres
createdb template_postgis
psql -d template_postgis -f /usr/share/postgresql/9.1/contrib/postgis-2.0/postgis.sql
psql -d template_postgis -f /usr/share/postgresql/9.1/contrib/postgis-2.0/spatial_ref_sys.sql

# # create DB using template to auto enable postgis
# owne dby current user

createdb farm -T template_postgis
psql farm

# create farmer table

CREATE TABLE farmers (fid int not null primary key,
name varchar(50),
address varchar(50),
area int,
notes varchar(100))
;

CREATE TABLE paddocks (fid int references farmers(fid) not null,
pid int not null primary key,
area int,
cover int,
notes varchar(100),
geom geography)
;

CREATE TABLE observations (
date TIMESTAMP WITH TIME ZONE not null,
fid int references farmers(fid) not null,
pid int references pads(pid) not null,
cover int,
notes varchar(100),
the_geom geography)
;

INSERT INTO 	farmers (fid,name,address,area,notes)
		values (1003,'trevor and leigh indian', '97 ocean bvld, Jan Juc', 4000, 'useless dog called doug');

SELECT * FROM farmers;	

INSERT INTO 	paddocks	(fid, pid, area, cover, notes)
		values		(1003, 003, 4.3,2400,'creek paddock');

INSERT INTO 	observations 	(fid, pid, cover, notes)
		values		(1003, 003, 2400, 'needs spraying');

# in shell
createlang plpgsql farms
psql farms < /usr/share/postgresql/9.1/contrib/postgis-2.0/postgis.sql
psql farms < /usr/share/postgresql/9.1/contrib/postgis-2.0/spatial_ref_sys.sql


ALTER TABLE farmers ADD COLUMN the_geom geometry;

# to get shapefile from qgis into postgis - need to sort out shapefiles projection as SRI code.
shp2pgsql -s 4326 -d ~/mapping/farm_toJIZZ | psql -d farms

# merge two tables to find pid from survey results!!! DONE!
SELECT p.fid, p.pid, s.score FROM farm_tojizz p, survey s WHERE ST_CONTAINS(p.geom,s.geom);

# descending order on cover.
SELECT p.fid, p.pid, s.score as cover FROM farm_tojizz p, survey s WHERE ST_CONTAINS(p.geom,s.geom) ORDER BY cover DESC;
SELECT p.fid, p.pid, s.cover FROM farm_tojizz p, survey s WHERE ST_CONTAINS(p.geom,ST_Transform(s.geom,4326)) ORDER BY cover DESC;

############3
## form R
##############

# add geog column to obs
ALTER TABLE obs ADD COLUMN the_geog GEOGRAPHY;

#  read geog from string
UPDATE obs SET geography = ST_GeogFromText('POINT(' || lon || ' ' || lat || ')')

# proper spatial join - intersect allows geom and geog merge, contains only geom
SELECT o.dat as date, p.fid, p.pid,o.cover, o.notes, o.the_geom FROM pads p, obs o WHERE ST_INTERSECTS(p.geom, o.the_geom);
# as obs is geography, geog only allows st_intersects


#####
## fix table structure
#
#####

CREATE TABLE pads AS SELECT cast(fid as int), cast(pid as int),area,cast(cover as int), notes, geom from farm_tojizz ;

# add fkey constraints
ALTER TABLE pads ADD FOREIGN KEY(fid) REFERENCES farmers(fid);

# add pkey constraints
ALTER TABLE pads ADD PRIMARY KEY(pid);





# put obs into observations
INSERT INTO observations SELECT o.dat as date, p.fid, p.pid,o.cover, o.notes, o.the_geom FROM paddocks p, obs o WHERE ST_INTERSECTS(p.geom, o.the_geom);



######################
### new db - from shape file loaded via shp
###################
# better to create colum in postgres 

shp2pgsql -s 3111 -d ~/mapping/shp/juc_farms | psql -d farms

psql farm

ALTER TABLE juc_farms DROP COLUMN gid;

ALTER TABLE juc_farms ADD COLUMN fid int;

ALTER TABLE juc_farms ADD FOREIGN KEY(fid) references farmers(fid);

ALTER TABLE juc_farms ADD COLUMN pid int;


SELECT ST_SRID(geom) FROM paddocks ;



